<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Money Planner: Ultimate Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; background-color: #f8fafc; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        
        .input-group:focus-within label { color: #4f46e5; }
        .input-group:focus-within input, .input-group:focus-within select { border-color: #6366f1; ring: 2px; }
        
        .number-font { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; letter-spacing: -0.02em; }
        
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -7px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
    </style>
</head>
<body class="text-slate-800">

    <nav class="sticky top-0 z-50 glass-card border-b border-slate-200/80">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-none text-slate-900 tracking-tight">SmartMoney<span class="text-indigo-600">Planner</span></h1>
                    <p class="text-[10px] text-slate-500 font-medium tracking-wide uppercase mt-0.5">Ultimate Financial Simulator</p>
                </div>
            </div>
            <div class="hidden md:flex items-center gap-2 bg-slate-100/80 p-1 rounded-lg">
                <button onclick="setAnalysisMode('deposit')" id="nav-deposit" class="px-4 py-1.5 text-xs font-bold rounded-md transition-all shadow-sm bg-white text-indigo-600">Strategi Deposit</button>
                <button onclick="setAnalysisMode('tenure')" id="nav-tenure" class="px-4 py-1.5 text-xs font-bold rounded-md transition-all text-slate-500 hover:text-slate-700">Strategi Tempoh</button>
            </div>
        </div>
    </nav>

    <div class="md:hidden px-4 py-3 bg-white border-b border-slate-200">
        <div class="flex bg-slate-100 p-1 rounded-lg">
            <button onclick="setAnalysisMode('deposit')" id="mob-deposit" class="flex-1 py-2 text-xs font-bold rounded-md transition-all shadow-sm bg-white text-indigo-600">Banding Deposit</button>
            <button onclick="setAnalysisMode('tenure')" id="mob-tenure" class="flex-1 py-2 text-xs font-bold rounded-md transition-all text-slate-500">Banding Tempoh</button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-5">
                
                <div class="glass-card rounded-2xl p-1.5 flex gap-1">
                    <button onclick="setLoanType('car')" id="btn-car" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold transition-all bg-indigo-50 text-indigo-700 border border-indigo-100 shadow-sm">
                        <i data-lucide="car" class="w-4 h-4"></i> Kereta
                    </button>
                    <button onclick="setLoanType('house')" id="btn-house" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-medium transition-all text-slate-500 hover:bg-slate-50">
                        <i data-lucide="home" class="w-4 h-4"></i> Rumah
                    </button>
                </div>

                <div class="glass-card rounded-2xl p-4 bg-gradient-to-br from-indigo-50 to-white border-indigo-100">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                            <i data-lucide="briefcase" class="w-3.5 h-3.5"></i>
                        </div>
                        <span class="text-xs font-bold text-indigo-900 uppercase tracking-wide">Profil Pekerjaan</span>
                    </div>
                    <div class="flex bg-white rounded-lg p-1 border border-indigo-100 shadow-sm">
                        <button onclick="setJobType('permanent')" id="btn-perm" class="flex-1 py-2 px-3 rounded-md text-xs font-bold transition-all bg-indigo-600 text-white shadow-sm">Tetap (Stabil)</button>
                        <button onclick="setJobType('contract')" id="btn-cont" class="flex-1 py-2 px-3 rounded-md text-xs font-bold transition-all text-slate-500 hover:bg-slate-50">Kontrak / Freelance</button>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-6 space-y-6">
                    <div class="flex items-center justify-between border-b border-slate-100 pb-3">
                        <h2 class="font-bold text-slate-800 text-sm uppercase tracking-wider">Parameter Utama</h2>
                        <span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500 font-bold">LANGKAH 1</span>
                    </div>

                    <div class="input-group">
                        <div class="flex justify-between mb-1.5">
                            <label class="text-xs font-semibold text-slate-500">Harga Aset</label>
                            <span class="text-xs font-bold text-indigo-600 number-font" id="disp-assetPrice">RM 0</span>
                        </div>
                        <div class="relative">
                            <input type="number" id="assetPrice" placeholder="0" class="w-full pl-3 pr-10 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:outline-none focus:bg-white transition-all number-font" oninput="syncInput('assetPrice')">
                            <div class="absolute right-3 top-2.5 text-xs font-bold text-slate-400">MYR</div>
                        </div>
                        <input type="range" min="0" max="1000000" step="1000" value="0" class="mt-3" oninput="document.getElementById('assetPrice').value = this.value; syncInput('assetPrice')">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5">Tempoh (Tahun)</label>
                            <input type="number" id="loanTenure" value="9" class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:outline-none focus:bg-white transition-all number-font" oninput="calculate()">
                        </div>
                        <div class="input-group">
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5">Kadar Bank (%)</label>
                            <input type="number" id="loanRate" value="3.0" step="0.1" class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:outline-none focus:bg-white transition-all number-font" oninput="calculate()">
                        </div>
                    </div>

                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-semibold text-slate-500">Jenis Kadar</label>
                            <span class="text-[10px] text-slate-400" id="method-hint">Biasanya Flat Rate untuk kereta</span>
                        </div>
                        <select id="calcMethod" class="w-full bg-white border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 font-medium" onchange="calculate()">
                            <option value="flat">Flat Rate (Tetap)</option>
                            <option value="reducing">Reducing Balance (Baki Berkurang)</option>
                        </select>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-6 space-y-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-6 opacity-10 pointer-events-none">
                        <i data-lucide="trending-up" class="w-24 h-24 text-emerald-600"></i>
                    </div>

                    <div class="flex items-center justify-between border-b border-slate-100 pb-3 relative z-10">
                        <h2 class="font-bold text-slate-800 text-sm uppercase tracking-wider" id="strategy-title">Strategi Deposit</h2>
                        <span class="text-[10px] bg-emerald-50 text-emerald-700 px-2 py-1 rounded font-bold border border-emerald-100">LANGKAH 2</span>
                    </div>

                    <div class="space-y-5 relative z-10">
                        
                        <div id="inputs-deposit-mode">
                            <div class="flex justify-between mb-1.5">
                                <label class="text-xs font-semibold text-emerald-700">Tunai Di Tangan</label>
                                <span class="text-xs font-bold text-emerald-600 number-font" id="disp-cashOnHand">RM 0</span>
                            </div>
                            <div class="relative">
                                <input type="number" id="cashOnHand" placeholder="0" class="w-full pl-3 pr-10 py-2.5 bg-emerald-50/50 border border-emerald-100 rounded-xl text-sm font-bold text-emerald-800 focus:outline-none focus:bg-white focus:border-emerald-500 transition-all number-font" oninput="syncInput('cashOnHand')">
                            </div>
                            <input type="range" min="0" max="200000" step="1000" value="0" class="mt-3 accent-emerald-600" oninput="document.getElementById('cashOnHand').value = this.value; syncInput('cashOnHand')">
                        </div>

                        <div id="inputs-tenure-mode" class="hidden">
                            <label class="block text-xs font-semibold text-emerald-700 mb-1.5">Target Tempoh Pendek (Tahun)</label>
                            <input type="number" id="shortTenure" value="5" class="w-full px-3 py-2.5 bg-emerald-50/50 border border-emerald-100 rounded-xl text-sm font-bold text-emerald-800 focus:outline-none focus:bg-white focus:border-emerald-500 transition-all number-font" oninput="calculate()">
                            <p class="text-[10px] text-slate-500 mt-2 leading-relaxed">
                                Senario ini membandingkan menyelesaikan hutang dalam tempoh ini vs tempoh asal, dan melaburkan lebihan wang.
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-1.5">Dividen ASB (%)</label>
                                <input type="number" id="asbRate" value="5.5" step="0.1" class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:outline-none focus:bg-white transition-all number-font" oninput="calculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-1.5">Min. Deposit (%)</label>
                                <input type="number" id="minDepoPercent" value="10" class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 focus:outline-none focus:bg-white transition-all number-font" oninput="calculate()">
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-4 relative z-10" id="adv-settings-container">
                        <button onclick="toggleAdvanced()" class="flex items-center gap-2 text-xs font-semibold text-slate-400 hover:text-indigo-600 transition-colors w-full">
                            <i data-lucide="settings-2" class="w-3 h-3"></i>
                            Tetapan Lanjutan
                            <i data-lucide="chevron-down" id="adv-chevron" class="w-3 h-3 ml-auto transition-transform"></i>
                        </button>
                        
                        <div id="advanced-options" class="hidden mt-4 space-y-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                            
                            <div id="auto-match-control" class="flex items-center justify-between bg-white p-2.5 rounded-lg border border-slate-200 shadow-sm">
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-slate-700">Samakan Komitmen</span>
                                    <span class="text-[10px] text-slate-400 font-medium">Bayar baki tunai ke Principal</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="autoMatchToggle" class="sr-only peer" onchange="toggleAutoMatch()">
                                    <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                                </label>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold text-indigo-600 mb-1.5">Bayaran Ekstra Manual (A)</label>
                                <input type="number" id="extraPayment" placeholder="0" class="w-full px-3 py-2 bg-white border border-indigo-100 rounded-lg text-sm font-bold text-indigo-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 number-font" oninput="calculate()">
                                <p class="text-[10px] text-slate-400 mt-1">Hanya berkesan jika Samakan Komitmen dimatikan.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="lg:col-span-8 space-y-6">
                
                <div id="verdict-card" class="bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-2xl p-6 md:p-8 shadow-xl relative overflow-hidden group">
                    <div class="absolute right-0 top-0 h-full w-1/2 bg-white/5 skew-x-12 transform origin-top-right transition-transform group-hover:scale-110 duration-700"></div>
                    
                    <div class="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-6">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                                <span class="text-xs font-bold text-slate-300 uppercase tracking-widest">Keputusan Analisa</span>
                            </div>
                            <h2 id="verdict-text" class="text-2xl md:text-4xl font-bold tracking-tight mb-2">Mengira...</h2>
                            <p id="verdict-sub" class="text-slate-400 text-sm max-w-lg">Berdasarkan data yang anda masukkan.</p>
                        </div>
                        <div class="flex-shrink-0 text-center md:text-right">
                            <div class="text-xs text-slate-400 font-medium uppercase mb-1">Nilai Bersih Tambahan</div>
                            <div id="verdict-value" class="text-3xl md:text-4xl font-extrabold text-emerald-400 number-font">RM 0</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-shadow duration-300 flex flex-col">
                        <div class="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-slate-900" id="title-A">Senario A</h3>
                                <p class="text-xs text-slate-500 font-medium mt-0.5" id="sub-A">Penerangan A</p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold shadow-sm">A</div>
                        </div>
                        
                        <div class="p-6 space-y-5 flex-1">
                            <div class="space-y-3">
                                <div id="row-A-deposit" class="flex justify-between items-center">
                                    <span class="text-sm text-slate-500">Deposit Dibayar</span>
                                    <span class="text-sm font-bold text-slate-900 number-font" id="res-A-deposit">RM 0</span>
                                </div>
                                <div id="row-A-tenure" class="hidden flex justify-between items-center">
                                    <span class="text-sm text-slate-500">Tempoh Pinjaman</span>
                                    <span class="text-sm font-bold text-slate-900 number-font" id="res-A-tenure-display">0 Thn</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-slate-500">Jumlah Pinjaman</span>
                                    <span class="text-sm font-bold text-slate-900 number-font" id="res-A-loan">RM 0</span>
                                </div>
                                <div class="flex justify-between items-start p-3 bg-slate-50 rounded-lg border border-slate-100">
                                    <span class="text-sm font-semibold text-slate-700 mt-1">Komitmen Bulanan</span>
                                    <div class="text-right">
                                        <div class="text-sm font-bold text-slate-900 number-font" id="res-A-monthly">RM 0</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-slate-50">
                                    <span class="text-xs text-slate-400">Jumlah Faedah (Interest)</span>
                                    <span class="text-xs font-bold text-rose-500 number-font" id="res-A-interest">RM 0</span>
                                </div>
                            </div>

                            <div id="block-A-invest" class="mt-auto pt-4 border-t border-slate-100 hidden">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-indigo-600 font-semibold" id="lbl-A-invest">Hasil Pelaburan Semula</span>
                                    <span class="text-xs font-bold text-indigo-600 number-font" id="res-A-asb">RM 0</span>
                                </div>
                                <div class="h-1.5 w-full bg-indigo-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-indigo-500 w-full"></div>
                                </div>
                                <div id="invest-details-A" class="hidden text-[10px] text-slate-500 mt-2 flex justify-between">
                                    <span>Modal: <span id="res-A-initialInvest" class="font-bold">RM 0</span></span>
                                    <span>Dividen: <span id="res-A-totalDividend" class="font-bold text-indigo-600">RM 0</span></span>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-indigo-50 border-t border-indigo-100">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-bold text-indigo-800 uppercase tracking-wide">Aset Bersih Akhir</span>
                                <span class="text-lg font-extrabold text-indigo-700 number-font" id="res-A-net">RM 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-shadow duration-300 flex flex-col">
                        <div class="p-5 border-b border-slate-100 bg-emerald-50/30 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-slate-900" id="title-B">Senario B</h3>
                                <p class="text-xs text-slate-500 font-medium mt-0.5" id="sub-B">Penerangan B</p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 font-bold shadow-sm">B</div>
                        </div>
                        
                        <div class="p-6 space-y-5 flex-1">
                            <div class="space-y-3">
                                <div id="row-B-deposit" class="flex justify-between items-center">
                                    <span class="text-sm text-slate-500">Deposit Dibayar</span>
                                    <span class="text-sm font-bold text-slate-900 number-font" id="res-B-deposit">RM 0</span>
                                </div>
                                <div id="row-B-tenure" class="hidden flex justify-between items-center">
                                    <span class="text-sm text-slate-500">Tempoh Pinjaman</span>
                                    <span class="text-sm font-bold text-slate-900 number-font" id="res-B-tenure-display">0 Thn</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-slate-500">Jumlah Pinjaman</span>
                                    <span class="text-sm font-bold text-slate-900 number-font" id="res-B-loan">RM 0</span>
                                </div>
                                <div class="flex justify-between items-start p-3 bg-emerald-50/50 rounded-lg border border-emerald-100">
                                    <span class="text-sm font-semibold text-slate-700 mt-1">Komitmen Bulanan</span>
                                    <div class="text-right">
                                        <div class="text-sm font-bold text-slate-900 number-font" id="res-B-monthly">RM 0</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t border-slate-50">
                                    <span class="text-xs text-slate-400">Jumlah Faedah (Interest)</span>
                                    <span class="text-xs font-bold text-rose-500 number-font" id="res-B-interest">RM 0</span>
                                </div>
                            </div>

                            <div class="mt-auto pt-4 border-t border-slate-100">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs text-emerald-600 font-semibold">Info Pelaburan (ASB)</span>
                                </div>
                                <div class="flex justify-between text-[10px] text-slate-500 mb-2">
                                    <span>Modal: <span id="res-B-initialInvest" class="font-bold">RM 0</span></span>
                                    <span>Dividen: <span id="res-B-totalDividend" class="font-bold text-emerald-600">RM 0</span></span>
                                </div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-slate-500">Nilai Akhir ASB</span>
                                    <span class="text-xs font-bold text-emerald-600 number-font" id="res-B-asb">RM 0</span>
                                </div>
                                <div class="h-1.5 w-full bg-emerald-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-emerald-500 w-full"></div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-emerald-50 border-t border-emerald-100">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-bold text-emerald-800 uppercase tracking-wide">Aset Bersih Akhir</span>
                                <span class="text-lg font-extrabold text-emerald-700 number-font" id="res-B-net">RM 0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-bold text-slate-900">Unjuran Kekayaan Tahunan</h3>
                            <p class="text-xs text-slate-500">Pertumbuhan aset bersih dari tahun ke tahun.</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="downloadCSV()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-600 text-xs font-bold hover:bg-indigo-100 transition-colors">
                                <i data-lucide="download" class="w-3.5 h-3.5"></i> Laporan (CSV)
                            </button>
                            <button onclick="downloadChart()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-slate-50 text-slate-600 text-xs font-bold hover:bg-slate-100 transition-colors">
                                <i data-lucide="image" class="w-3.5 h-3.5"></i> Graf
                            </button>
                        </div>
                    </div>
                    <div class="h-72 w-full relative bg-white p-2 rounded-xl">
                        <canvas id="financeChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center gap-2 mb-4 pb-2 border-b border-slate-50">
                        <i data-lucide="shield-alert" class="w-5 h-5 text-amber-500"></i>
                        <h3 class="font-bold text-slate-900">Analisa Risiko & Kesuaian Profil</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-3">
                             <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center">
                                    <i data-lucide="briefcase" class="w-3 h-3 text-slate-600"></i>
                                </div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wide">Risiko Kehilangan Pekerjaan</h4>
                             </div>
                             <p id="risk-job-text" class="text-sm text-slate-600 leading-relaxed pl-8 border-l-2 border-slate-100">
                                Analisa sedang dimuatkan...
                             </p>
                        </div>
                        <div class="space-y-3">
                             <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center">
                                    <i data-lucide="user-check" class="w-3 h-3 text-slate-600"></i>
                                </div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wide">Profil Kesuaian</h4>
                             </div>
                             <p id="risk-profile-text" class="text-sm text-slate-600 leading-relaxed pl-8 border-l-2 border-slate-100">
                                Analisa sedang dimuatkan...
                             </p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        let currentLoanType = 'car'; 
        let analysisMode = 'deposit'; 
        let currentJobType = 'permanent';
        let chartInstance = null;

        function toggleAdvanced() {
            const el = document.getElementById('advanced-options');
            const chev = document.getElementById('adv-chevron');
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                chev.classList.add('rotate-180');
            } else {
                el.classList.add('hidden');
                chev.classList.remove('rotate-180');
            }
        }

        function toggleAutoMatch() {
            const isAuto = document.getElementById('autoMatchToggle').checked;
            const extraInput = document.getElementById('extraPayment');
            
            if (isAuto) {
                extraInput.disabled = true;
                extraInput.classList.add('bg-slate-100', 'text-slate-500');
                extraInput.classList.remove('bg-white', 'text-indigo-700');
            } else {
                extraInput.disabled = false;
                extraInput.value = 0; 
                extraInput.classList.remove('bg-slate-100', 'text-slate-500');
                extraInput.classList.add('bg-white', 'text-indigo-700');
            }
            calculate();
        }

        function formatRM(num) {
            if (isNaN(num)) return 'RM 0';
            return new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR', maximumFractionDigits: 0 }).format(num);
        }

        function parseVal(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            const val = parseFloat(el.value);
            return isNaN(val) ? 0 : val;
        }

        function syncInput(id) {
            const val = document.getElementById(id).value;
            const display = document.getElementById('disp-' + id);
            if (display) display.innerText = formatRM(val);
            calculate();
        }

        function setJobType(type) {
            currentJobType = type;
            const btnPerm = document.getElementById('btn-perm');
            const btnCont = document.getElementById('btn-cont');
            
            const activeStyle = "flex-1 py-2 px-3 rounded-md text-xs font-bold transition-all bg-indigo-600 text-white shadow-sm";
            const inactiveStyle = "flex-1 py-2 px-3 rounded-md text-xs font-bold transition-all text-slate-500 hover:bg-slate-50";

            if (type === 'permanent') {
                btnPerm.className = activeStyle;
                btnCont.className = inactiveStyle;
            } else {
                btnCont.className = activeStyle;
                btnPerm.className = inactiveStyle;
            }
            calculate();
        }

        function setLoanType(type) {
            currentLoanType = type;
            
            const btnCar = document.getElementById('btn-car');
            const btnHouse = document.getElementById('btn-house');
            const activeClass = "flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold transition-all bg-indigo-50 text-indigo-700 border border-indigo-100 shadow-sm";
            const inactiveClass = "flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-medium transition-all text-slate-500 hover:bg-slate-50";

            if (type === 'car') {
                btnCar.className = activeClass;
                btnHouse.className = inactiveClass;
                
                document.getElementById('loanRate').value = 3.0;
                document.getElementById('loanTenure').value = 9;
                document.getElementById('calcMethod').value = 'flat';
                document.getElementById('method-hint').innerText = "Biasanya Flat Rate untuk kereta";
                
                document.getElementById('auto-match-control').classList.add('hidden');
                document.getElementById('autoMatchToggle').checked = false; 
                document.getElementById('extraPayment').disabled = false;
            } else {
                btnHouse.className = activeClass;
                btnCar.className = inactiveClass;
                
                document.getElementById('loanRate').value = 4.2;
                document.getElementById('loanTenure').value = 30;
                document.getElementById('calcMethod').value = 'reducing';
                document.getElementById('method-hint').innerText = "Reducing Balance untuk rumah";
                
                document.getElementById('auto-match-control').classList.remove('hidden');
            }
            calculate();
        }

        function setAnalysisMode(mode) {
            analysisMode = mode;
            
            const ids = ['nav-deposit', 'nav-tenure', 'mob-deposit', 'mob-tenure'];
            const activeStyle = "bg-white text-indigo-600 shadow-sm";
            const inactiveStyle = "text-slate-500 hover:text-slate-700 bg-transparent shadow-none";

            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.className = `px-4 py-1.5 text-xs font-bold rounded-md transition-all ${inactiveStyle}`;
                    if (id.includes('mob')) el.classList.add('flex-1', 'py-2');
                }
            });

            const activeIds = mode === 'deposit' ? ['nav-deposit', 'mob-deposit'] : ['nav-tenure', 'mob-tenure'];
            activeIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.className = `px-4 py-1.5 text-xs font-bold rounded-md transition-all ${activeStyle}`;
                    if (id.includes('mob')) el.classList.add('flex-1', 'py-2');
                }
            });

            if (mode === 'deposit') {
                document.getElementById('inputs-deposit-mode').classList.remove('hidden');
                document.getElementById('inputs-tenure-mode').classList.add('hidden');
                
                document.getElementById('strategy-title').innerText = "Strategi Deposit";
                document.getElementById('title-A').innerText = "Strategi A";
                document.getElementById('sub-A').innerText = "Bayar Deposit Maksimum";
                document.getElementById('title-B').innerText = "Strategi B";
                document.getElementById('sub-B').innerText = "Deposit Min + Invest Baki";

                document.getElementById('row-A-deposit').classList.remove('hidden');
                document.getElementById('row-B-deposit').classList.remove('hidden');
                document.getElementById('row-A-tenure').classList.add('hidden');
                document.getElementById('row-B-tenure').classList.add('hidden');
                
                document.getElementById('block-A-invest').classList.add('hidden');
                document.getElementById('invest-details-A').classList.add('hidden');
            } else {
                document.getElementById('inputs-deposit-mode').classList.add('hidden');
                document.getElementById('inputs-tenure-mode').classList.remove('hidden');
                
                document.getElementById('strategy-title').innerText = "Strategi Tempoh";
                document.getElementById('title-A').innerText = "Strategi A";
                document.getElementById('sub-A').innerText = "Tempoh Pendek + Labur";
                document.getElementById('title-B').innerText = "Strategi B";
                document.getElementById('sub-B').innerText = "Tempoh Panjang + Invest";

                document.getElementById('row-A-deposit').classList.add('hidden');
                document.getElementById('row-B-deposit').classList.add('hidden');
                document.getElementById('row-A-tenure').classList.remove('hidden');
                document.getElementById('row-B-tenure').classList.remove('hidden');
                
                document.getElementById('block-A-invest').classList.remove('hidden');
                document.getElementById('invest-details-A').classList.remove('hidden');
            }
            calculate();
        }

        function calculateMonthly(principal, ratePct, years, method, extraMonthly = 0) {
            if (principal <= 0) return { monthly: 0, totalInterest: 0, actualMonths: 0 };
            
            let monthly = 0;
            let totalInterest = 0;
            let actualMonths = years * 12;

            if (method === 'flat') {
                totalInterest = principal * (ratePct/100) * years;
                monthly = (principal + totalInterest) / (years * 12);
            } else {
                let r = ratePct / 100 / 12;
                let n = years * 12;
                
                if (r === 0) {
                    monthly = principal / n;
                    totalInterest = 0;
                } else {
                    let baseMonthly = principal * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
                    
                    let balance = principal;
                    let actualPayment = baseMonthly + extraMonthly;
                    let accumInterest = 0;
                    let m = 0;
                    
                    while(balance > 0.1 && m < 1200) {
                        let interest = balance * r;
                        accumInterest += interest;
                        let principalPart = actualPayment - interest;
                        if (principalPart <= 0) break; 
                        balance -= principalPart;
                        m++;
                    }
                    monthly = baseMonthly; 
                    totalInterest = accumInterest;
                    actualMonths = m;
                }
            }
            return { monthly, totalInterest, actualMonths };
        }

        function updateRiskAnalysis(monthlyA, monthlyB, mode) {
            const riskJobEl = document.getElementById('risk-job-text');
            const riskProfileEl = document.getElementById('risk-profile-text');
            
            let diff = Math.abs(monthlyA - monthlyB);
            let lowerCommitmentLabel = monthlyA < monthlyB ? 'Strategi A (Komitmen Rendah)' : 'Strategi B (Komitmen Rendah)';
            let higherCommitmentLabel = monthlyA > monthlyB ? 'Strategi A (Komitmen Tinggi)' : 'Strategi B (Komitmen Tinggi)';
            
            let isFreelance = currentJobType === 'contract';
            
            let textJob = "";
            let textProfile = "";

            if (mode === 'deposit') {
                if (isFreelance) {
                    textJob = `<span class="text-amber-600 font-bold">Perhatian Freelancer!</span> Anda perlukan tunai kecemasan. <br>
                    <strong>Strategi B (Invest)</strong> mengekalkan tunai di tangan (ASB) yang sangat kritikal jika tiada job. Namun, komitmen bulanannya lebih tinggi.<br>
                    Jika anda yakin boleh bayar bulanan, <strong>Strategi B</strong> lebih selamat kerana ada "Buffer Tunai". Jika risau tak mampu bayar bulanan, pilih <strong>Strategi A</strong> untuk rendahkan komitmen.`;
                    
                    textProfile = `Sebagai pekerja kontrak, <strong>Likuiditi (Tunai Cair)</strong> adalah raja. Strategi B memberi anda akses pantas kepada tunai pelaburan jika berlaku kecemasan, berbanding Strategi A di mana wang "terbenam" dalam aset.`;
                } else {
                    textJob = `<strong class="text-emerald-600">${lowerCommitmentLabel}</strong> memberikan ketenangan minda dengan bayaran bulanan rendah. <br>Namun sebagai pekerja tetap, anda mungkin lebih selesa mengambil risiko <strong>${higherCommitmentLabel}</strong> untuk memaksimumkan pelaburan tunai di tangan.`;
                    
                    textProfile = `Pekerja Tetap mempunyai aliran tunai stabil. Fokus anda boleh lebih kepada memaksimumkan <strong>Nilai Bersih (Net Worth)</strong> jangka panjang berbanding risaukan likuiditi jangka pendek.`;
                }

            } else {
                if (isFreelance) {
                    textJob = `<span class="text-rose-600 font-bold">Amaran Risiko Tinggi!</span> Elakkan <strong>Strategi A (Tempoh Pendek)</strong> kerana komitmen bulanannya sangat tinggi. Jika hilang projek, anda akan tertekan.<br>
                    Pilih <strong>Strategi B (Tempoh Panjang)</strong> untuk rendahkan bayaran wajib. Anda boleh bayar lebih bila ada duit, tapi tak wajib.`;
                    
                    textProfile = `Fleksibiliti adalah kunci. Ambil tempoh panjang (B) untuk keselamatan. Gunakan lebihan pendapatan bulan-bulan "lebat" untuk simpanan sendiri, bukan terikat dengan bank.`;
                } else {
                    textJob = `Jika anda ada dana kecemasan 6 bulan, <strong>Strategi A (Pendek)</strong> bagus untuk bebas hutang cepat. Tapi jika ragu-ragu, ambil <strong>Strategi B (Panjang)</strong> dan laburkan bakinya secara disiplin.`;
                    
                    textProfile = `Untuk profil stabil, strategi agresif (A) boleh dipertimbangkan untuk menjimatkan faedah bank. Namun, strategi B memberi fleksibiliti tunai yang lebih baik untuk peluang pelaburan lain.`;
                }
            }
            
            riskJobEl.innerHTML = textJob;
            riskProfileEl.innerHTML = textProfile;
        }

        function calculate() {
            const P_asset = parseVal('assetPrice');
            const rateLoan = parseVal('loanRate');
            const method = document.getElementById('calcMethod').value;
            const rateAsb = parseVal('asbRate') / 100;
            const minDepoPct = parseVal('minDepoPercent');
            const isAutoMatch = document.getElementById('autoMatchToggle').checked;
            
            if (method === 'flat') {
                document.getElementById('auto-match-control').classList.add('hidden');
            } else {
                document.getElementById('auto-match-control').classList.remove('hidden');
            }

            let extraMonthly = 0;
            const commonTenure = parseVal('loanTenure'); 
            
            if (method === 'reducing' && !isAutoMatch) {
                extraMonthly = parseVal('extraPayment');
            }

            const minDepoAmount = P_asset * (minDepoPct / 100);

            let A_loan, B_loan;
            let A_monthly, B_monthly;
            let chartLabels = [], chartDataA = [], chartDataB = [];
            let A_finalInvest = 0, B_finalInvest = 0; 

            if (analysisMode === 'deposit') {
                let cash = parseVal('cashOnHand');
                let A_depo = Math.max(cash, minDepoAmount);
                let B_depo = minDepoAmount;
                
                A_loan = Math.max(0, P_asset - A_depo);
                B_loan = Math.max(0, P_asset - B_depo);
                
                let B_startInvest = Math.max(0, cash - B_depo);

                let autoExtraA = 0;
                if (method === 'reducing' && isAutoMatch) {
                    const baseA = calculateMonthly(A_loan, rateLoan, commonTenure, method, 0);
                    const baseB = calculateMonthly(B_loan, rateLoan, commonTenure, method, 0);
                    const diff = baseB.monthly - baseA.monthly;
                    if (diff > 0) {
                        autoExtraA = diff;
                    }
                    document.getElementById('extraPayment').value = autoExtraA.toFixed(0);
                    extraMonthly = autoExtraA; 
                }

                const resA = calculateMonthly(A_loan, rateLoan, commonTenure, method, extraMonthly);
                const resB = calculateMonthly(B_loan, rateLoan, commonTenure, method, 0); 

                A_monthly = resA.monthly;
                B_monthly = resB.monthly;

                B_finalInvest = B_startInvest * Math.pow((1 + rateAsb), commonTenure);
                let B_dividend = B_finalInvest - B_startInvest;
                
                let interestDiff = resB.totalInterest - resA.totalInterest;
                let netWin = 0;

                let A_earlyInvestVal = 0;
                let A_earlyInvestPrinc = 0;
                let A_totalCommitment = A_monthly + extraMonthly; 

                if (method === 'reducing' && isAutoMatch && resA.actualMonths < commonTenure * 12) {
                    let remainingMonths = (commonTenure * 12) - resA.actualMonths;
                    let monthlyRateAsb = rateAsb / 12;
                    
                    for(let m=1; m <= remainingMonths; m++) {
                        A_earlyInvestVal = A_earlyInvestVal * (1 + monthlyRateAsb);
                        A_earlyInvestVal += A_totalCommitment;
                        A_earlyInvestPrinc += A_totalCommitment;
                    }
                    
                    A_finalInvest = A_earlyInvestVal;
                }

                if (method === 'flat') {
                    let diffMonthly = 0;
                    if (B_monthly > A_monthly) {
                        diffMonthly = B_monthly - A_monthly;
                    }

                    let monthlyRateAsb = rateAsb / 12;
                    let fundA = 0;
                    let A_totalPrinc = 0;
                    
                    for (let m = 1; m <= commonTenure * 12; m++) {
                        fundA = fundA * (1 + monthlyRateAsb);
                        fundA += diffMonthly;
                        A_totalPrinc += diffMonthly;
                    }
                    A_finalInvest = fundA;

                    netWin = B_finalInvest - A_finalInvest;

                    document.getElementById('res-A-initialInvest').innerText = formatRM(A_totalPrinc);
                    document.getElementById('res-A-totalDividend').innerText = formatRM(A_finalInvest - A_totalPrinc);
                    document.getElementById('res-A-asb').innerText = formatRM(A_finalInvest);
                    document.getElementById('res-A-net').innerText = formatRM(A_finalInvest);
                    
                    document.getElementById('block-A-invest').classList.remove('hidden');
                    document.getElementById('invest-details-A').classList.remove('hidden');
                    document.getElementById('lbl-A-invest').innerText = "Hasil Pelaburan Lebihan";

                    let monthlyTextA = formatRM(A_monthly);
                    monthlyTextA += `<span class="text-[10px] text-indigo-600 block mt-1 text-right w-max ml-auto border-t border-indigo-100 pt-0.5">Simpan: ${formatRM(diffMonthly)} (Beza)</span>`;
                    document.getElementById('res-A-monthly').innerHTML = monthlyTextA;
                    document.getElementById('res-B-monthly').innerText = formatRM(B_monthly);
                    document.getElementById('res-B-net').innerText = formatRM(B_finalInvest);

                    for (let i = 0; i <= commonTenure; i++) {
                        chartLabels.push(`Thn ${i}`);
                        
                        let fA = 0;
                        for(let m=1; m<=i*12; m++) {
                            fA = fA * (1 + monthlyRateAsb) + diffMonthly;
                        }
                        chartDataA.push(fA);

                        let fB = B_startInvest * Math.pow(1 + rateAsb, i);
                        chartDataB.push(fB);
                    }

                } else {
                    if (isAutoMatch) {
                        let valA_net = A_finalInvest - resA.totalInterest;
                        let valB_net = B_finalInvest - resB.totalInterest;
                        netWin = valB_net - valA_net;
                        
                        if (A_finalInvest > 0) {
                            document.getElementById('block-A-invest').classList.remove('hidden');
                            document.getElementById('lbl-A-invest').innerText = "Pelaburan Selepas Hutang";
                            document.getElementById('res-A-asb').innerText = formatRM(A_finalInvest);
                            document.getElementById('invest-details-A').classList.remove('hidden');
                            document.getElementById('res-A-initialInvest').innerText = formatRM(A_earlyInvestPrinc);
                            document.getElementById('res-A-totalDividend').innerText = formatRM(A_finalInvest - A_earlyInvestPrinc);
                            
                            let monthlyTextA = formatRM(A_monthly);
                            let settleBadge = "";
                            if (resA.actualMonths < commonTenure * 12) {
                                const y = Math.floor(resA.actualMonths / 12);
                                const m = Math.round(resA.actualMonths % 12);
                                let label = y > 0 ? `${y} Tahun ` : "";
                                label += m > 0 ? `${m} Bulan` : "";
                                settleBadge = `<span class="text-[10px] text-emerald-600 font-bold block mt-1 text-right bg-emerald-50 rounded px-1 w-max ml-auto border border-emerald-100">Selesai: ${label}</span>`;
                            }
                            monthlyTextA += `<span class="text-[10px] text-indigo-600 block mt-1 text-right w-max ml-auto border-t border-indigo-100 pt-0.5">+ Extra ${formatRM(extraMonthly)}</span>`;
                            if(settleBadge) monthlyTextA += settleBadge;
                            monthlyTextA += `<span class="text-[10px] text-indigo-600 block mt-1 text-right w-max ml-auto border-t border-indigo-100 pt-0.5">Labur: ${formatRM(A_totalCommitment)} (Slps Lunas)</span>`;
                            document.getElementById('res-A-monthly').innerHTML = monthlyTextA;
                        } else {
                             document.getElementById('block-A-invest').classList.add('hidden');
                             updateMonthlyDisplay(A_monthly, B_monthly, extraMonthly, resA.actualMonths, resB.actualMonths, commonTenure * 12);
                        }
                        
                        document.getElementById('res-A-net').innerText = formatRM(valA_net);
                        document.getElementById('res-B-net').innerText = formatRM(valB_net);

                    } else {
                        let monthlySurplus = 0;
                        if (B_monthly > A_monthly) {
                            monthlySurplus = B_monthly - A_monthly;
                        }
                        
                        let monthlyRateAsb = rateAsb / 12;
                        let fundA = 0;
                        let A_totalPrinc = 0;
                        for (let m = 1; m <= commonTenure * 12; m++) {
                            fundA = fundA * (1 + monthlyRateAsb);
                            fundA += monthlySurplus;
                            A_totalPrinc += monthlySurplus;
                        }
                        A_finalInvest = fundA;
                        
                        let valA_net = A_finalInvest - resA.totalInterest;
                        let valB_net = B_finalInvest - resB.totalInterest;
                        netWin = valB_net - valA_net;

                        if (monthlySurplus > 0) {
                            document.getElementById('block-A-invest').classList.remove('hidden');
                            document.getElementById('lbl-A-invest').innerText = "Pelaburan Lebihan Tunai";
                            document.getElementById('res-A-asb').innerText = formatRM(A_finalInvest);
                            document.getElementById('invest-details-A').classList.remove('hidden');
                            document.getElementById('res-A-initialInvest').innerText = formatRM(A_totalPrinc);
                            document.getElementById('res-A-totalDividend').innerText = formatRM(A_finalInvest - A_totalPrinc);
                            
                            let monthlyTextA = formatRM(A_monthly);
                            monthlyTextA += `<span class="text-[10px] text-indigo-600 block mt-1 text-right w-max ml-auto border-t border-indigo-100 pt-0.5">Simpan: ${formatRM(monthlySurplus)}/bln</span>`;
                            document.getElementById('res-A-monthly').innerHTML = monthlyTextA;
                        } else {
                            document.getElementById('block-A-invest').classList.add('hidden');
                            updateMonthlyDisplay(A_monthly, B_monthly, extraMonthly, resA.actualMonths, resB.actualMonths, commonTenure * 12);
                        }
                        document.getElementById('res-A-net').innerText = formatRM(valA_net);
                        document.getElementById('res-B-net').innerText = formatRM(valB_net);
                    }

                    for (let i = 0; i <= commonTenure; i++) {
                        chartLabels.push(`Thn ${i}`);
                        
                        let valA = 0;
                        if (isAutoMatch) {
                            let monthsPassed = i * 12;
                            if (monthsPassed <= resA.actualMonths) {
                                valA = -(resA.totalInterest / resA.actualMonths * monthsPassed);
                            } else {
                                let monthsInvested = monthsPassed - resA.actualMonths;
                                let monthlyRateAsb = rateAsb / 12;
                                let investVal = 0;
                                for(let m=1; m <= monthsInvested; m++) {
                                    investVal = investVal * (1 + monthlyRateAsb) + A_totalCommitment;
                                }
                                valA = investVal - resA.totalInterest;
                            }
                        } else {
                            let monthlySurplus = (B_monthly > A_monthly) ? B_monthly - A_monthly : 0;
                            let monthlyRateAsb = rateAsb / 12;
                            let investVal = 0;
                            for(let m=1; m <= i * 12; m++) {
                                investVal = investVal * (1 + monthlyRateAsb) + monthlySurplus;
                            }
                            valA = investVal - (resA.totalInterest / commonTenure * i);
                        }
                        chartDataA.push(valA);

                        let valB = B_startInvest * Math.pow(1 + rateAsb, i) - (resB.totalInterest / commonTenure * i);
                        chartDataB.push(valB);
                    }
                }

                document.getElementById('res-A-deposit').innerText = formatRM(A_depo);
                document.getElementById('res-B-deposit').innerText = formatRM(B_depo);
                
                document.getElementById('res-B-initialInvest').innerText = formatRM(B_startInvest);
                document.getElementById('res-B-totalDividend').innerText = formatRM(B_dividend);
                document.getElementById('res-B-asb').innerText = formatRM(B_finalInvest);

                updateVerdict(netWin, "Strategi B (Invest)", "Strategi A (Deposit Tinggi)");
                updateRiskAnalysis(A_monthly + (isAutoMatch ? extraMonthly : 0), B_monthly, 'deposit');
                
                document.getElementById('res-A-loan').innerText = formatRM(A_loan);
                document.getElementById('res-B-loan').innerText = formatRM(B_loan);
                document.getElementById('res-A-interest').innerText = formatRM(resA.totalInterest);
                document.getElementById('res-B-interest').innerText = formatRM(resB.totalInterest);

            } else {
                let A_tenure = parseVal('shortTenure');
                let B_tenure = commonTenure;
                
                if(A_tenure >= B_tenure) A_tenure = B_tenure - 1;
                if(A_tenure < 1) A_tenure = 1;

                let loanAmount = P_asset - minDepoAmount;
                
                const resA = calculateMonthly(loanAmount, rateLoan, A_tenure, method, 0); 
                const resB = calculateMonthly(loanAmount, rateLoan, B_tenure, method, 0); 

                A_monthly = resA.monthly;
                B_monthly = resB.monthly;

                let monthlyRateAsb = rateAsb / 12;
                
                let fundA = 0;
                let A_principal = 0;
                for(let m=1; m <= B_tenure*12; m++) {
                    fundA = fundA * (1 + monthlyRateAsb);
                    if(m > A_tenure*12) {
                        fundA += A_monthly;
                        A_principal += A_monthly;
                    }
                }
                A_finalInvest = fundA;

                let monthlyDiff = A_monthly - B_monthly;
                let fundB = 0;
                let B_principal = 0;
                for(let m=1; m <= B_tenure*12; m++) {
                    fundB = fundB * (1 + monthlyRateAsb);
                    fundB += monthlyDiff;
                    B_principal += monthlyDiff;
                }
                B_finalInvest = fundB;

                let netWin = B_finalInvest - A_finalInvest;

                document.getElementById('res-A-tenure-display').innerText = A_tenure + " Thn";
                document.getElementById('res-B-tenure-display').innerText = B_tenure + " Thn";
                
                document.getElementById('lbl-A-invest').innerText = "Hasil Pelaburan (Selepas Hutang)";
                document.getElementById('res-A-initialInvest').innerText = formatRM(A_principal);
                document.getElementById('res-A-totalDividend').innerText = formatRM(A_finalInvest - A_principal);
                document.getElementById('res-A-asb').innerText = formatRM(A_finalInvest);
                document.getElementById('res-A-net').innerText = formatRM(A_finalInvest);

                document.getElementById('res-B-initialInvest').innerText = formatRM(B_principal);
                document.getElementById('res-B-totalDividend').innerText = formatRM(B_finalInvest - B_principal);
                document.getElementById('res-B-asb').innerText = formatRM(B_finalInvest);
                document.getElementById('res-B-net').innerText = formatRM(B_finalInvest);

                document.getElementById('res-A-loan').innerText = formatRM(loanAmount);
                document.getElementById('res-B-loan').innerText = formatRM(loanAmount);
                document.getElementById('res-A-interest').innerText = formatRM(resA.totalInterest);
                document.getElementById('res-B-interest').innerText = formatRM(resB.totalInterest);
                
                const investTextA = `<span class="text-[10px] text-indigo-600 block mt-1 text-right w-max ml-auto border-t border-indigo-100 pt-0.5">Labur: ${formatRM(A_monthly)} (Slps Thn ${A_tenure})</span>`;
                const investTextB = `<span class="text-[10px] text-emerald-600 block mt-1 text-right w-max ml-auto border-t border-emerald-100 pt-0.5">Labur: ${formatRM(monthlyDiff)} (Setiap Bulan)</span>`;

                updateMonthlyDisplay(A_monthly, B_monthly, 0, resA.actualMonths, resB.actualMonths, B_tenure * 12, investTextA, investTextB);

                updateVerdict(netWin, "Strategi B (Tempoh Panjang)", "Strategi A (Tempoh Pendek)");
                updateRiskAnalysis(A_monthly, B_monthly, 'tenure');

                for (let i = 0; i <= B_tenure; i++) {
                    chartLabels.push(`Thn ${i}`);
                    
                    let fA = 0;
                    for(let m=1; m<=i*12; m++) {
                        fA = fA * (1 + monthlyRateAsb);
                        if(m > A_tenure*12) fA += A_monthly;
                    }
                    chartDataA.push(fA);

                    let fB = 0;
                    for(let m=1; m<=i*12; m++) {
                        fB = fB * (1 + monthlyRateAsb);
                        fB += monthlyDiff;
                    }
                    chartDataB.push(fB);
                }
            }

            updateChart(chartLabels, chartDataA, chartDataB);
        }

        function updateMonthlyDisplay(valA, valB, extra, monthsA, monthsB, originalMonths, appendA = "", appendB = "") {
            let txtA = formatRM(valA);
            let txtB = formatRM(valB);
            
            if (extra > 0) {
                const badge = `<span class="text-[10px] text-indigo-600 block bg-indigo-50 rounded px-1 mt-0.5 w-max ml-auto border border-indigo-100">+ Extra ${formatRM(extra)}</span>`;
                txtA += badge;
            }

            if (monthsA < originalMonths) {
                const y = Math.floor(monthsA / 12);
                const m = Math.round(monthsA % 12);
                let label = "";
                if (y > 0) label += `${y} Tahun`;
                if (m > 0) label += ` ${m} Bulan`;
                if (!label) label = "0 Bulan";

                const settleBadge = `<span class="text-[10px] text-emerald-600 font-bold block mt-1 text-right bg-emerald-50 rounded px-1 w-max ml-auto border border-emerald-100">Selesai: ${label}</span>`;
                txtA += settleBadge;
            }

            if (monthsB < originalMonths) {
                const y = Math.floor(monthsB / 12);
                const m = Math.round(monthsB % 12);
                let label = "";
                if (y > 0) label += `${y} Tahun`;
                if (m > 0) label += ` ${m} Bulan`;
                if (!label) label = "0 Bulan";

                const settleBadge = `<span class="text-[10px] text-emerald-600 font-bold block mt-1 text-right bg-emerald-50 rounded px-1 w-max ml-auto border border-emerald-100">Selesai: ${label}</span>`;
                txtB += settleBadge;
            }

            if (appendA) txtA += appendA;
            if (appendB) txtB += appendB;

            document.getElementById('res-A-monthly').innerHTML = txtA;
            document.getElementById('res-B-monthly').innerHTML = txtB;
        }

        function updateVerdict(netWin, winnerName, loserName) {
            const elText = document.getElementById('verdict-text');
            const elVal = document.getElementById('verdict-value');
            const elSub = document.getElementById('verdict-sub');
            const card = document.getElementById('verdict-card');

            if (netWin > 0) {
                elText.innerText = "Pilih " + winnerName;
                elText.className = "text-2xl md:text-3xl font-bold tracking-tight mb-2 text-emerald-300";
                elVal.innerText = "+ " + formatRM(netWin);
                elVal.className = "text-3xl md:text-4xl font-extrabold text-emerald-400 number-font";
                elSub.innerText = `${winnerName} memberikan nilai bersih lebih tinggi berbanding ${loserName}.`;
                card.className = "bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-2xl p-6 md:p-8 shadow-xl relative overflow-hidden group border-b-4 border-emerald-500";
            } else {
                elText.innerText = "Pilih " + loserName; 
                elText.className = "text-2xl md:text-3xl font-bold tracking-tight mb-2 text-indigo-300";
                elVal.innerText = "+ " + formatRM(Math.abs(netWin));
                elVal.className = "text-3xl md:text-4xl font-extrabold text-indigo-400 number-font";
                elSub.innerText = `${loserName} lebih menjimatkan atau menguntungkan dalam senario ini.`;
                card.className = "bg-gradient-to-r from-slate-900 to-indigo-950 text-white rounded-2xl p-6 md:p-8 shadow-xl relative overflow-hidden group border-b-4 border-indigo-500";
            }
        }

        function updateChart(labels, dataA, dataB) {
            const ctx = document.getElementById('financeChart')?.getContext('2d');
            if (!ctx) return; 

            if (chartInstance) chartInstance.destroy();

            if (typeof Chart === 'undefined') {
                console.error("Chart.js failed to load");
                return;
            }

            Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
            Chart.defaults.color = '#64748b';

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Strategi A',
                            data: dataA,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            fill: true
                        },
                        {
                            label: 'Strategi B',
                            data: dataB,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: 600 },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR', maximumFractionDigits: 0 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                callback: function(value) { return 'RM ' + value/1000 + 'k'; },
                                font: { size: 11, weight: 500 }
                            },
                            grid: { color: '#f1f5f9', borderDash: [4, 4] },
                            border: { display: false }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
        }

        function downloadCSV() {
            const P_asset = parseVal('assetPrice');
            const rateLoan = parseVal('loanRate');
            const method = document.getElementById('calcMethod').value;
            const rateAsb = parseVal('asbRate') / 100;
            const minDepoPct = parseVal('minDepoPercent');
            const isAutoMatch = document.getElementById('autoMatchToggle').checked;
            let extraMonthly = (method === 'reducing' && !isAutoMatch) ? parseVal('extraPayment') : 0;
            const commonTenure = parseVal('loanTenure'); 
            const minDepoAmount = P_asset * (minDepoPct / 100);

            let A_loan, B_loan;
            let cash = parseVal('cashOnHand');
            let A_depo, B_depo, B_startInvest;
            let autoExtraA = 0;

            if (analysisMode === 'deposit') {
                A_depo = Math.max(cash, minDepoAmount);
                B_depo = minDepoAmount;
                A_loan = Math.max(0, P_asset - A_depo);
                B_loan = Math.max(0, P_asset - B_depo);
                B_startInvest = Math.max(0, cash - B_depo);

                if (method === 'reducing' && isAutoMatch) {
                    const baseA = calculateMonthly(A_loan, rateLoan, commonTenure, method, 0);
                    const baseB = calculateMonthly(B_loan, rateLoan, commonTenure, method, 0);
                    const diff = baseB.monthly - baseA.monthly;
                    if (diff > 0) autoExtraA = diff;
                    extraMonthly = autoExtraA; 
                }
            } else {
                let A_tenure = parseVal('shortTenure');
                let B_tenure = commonTenure;
                if(A_tenure >= B_tenure) A_tenure = B_tenure - 1;
                if(A_tenure < 1) A_tenure = 1;
                
                A_loan = P_asset - minDepoAmount;
                B_loan = P_asset - minDepoAmount;
                B_startInvest = 0; 
            }

            const calcA = calculateMonthly(A_loan, rateLoan, analysisMode === 'deposit' ? commonTenure : parseVal('shortTenure'), method, extraMonthly);
            const calcB = calculateMonthly(B_loan, rateLoan, commonTenure, method, 0);

            let monthlyPaymentA = calcA.monthly + (analysisMode === 'deposit' ? extraMonthly : 0);
            let monthlyPaymentB = calcB.monthly;

            let monthlySurplusA = 0;
            if (analysisMode === 'deposit') {
                 if (method === 'flat' || (method === 'reducing' && !isAutoMatch)) {
                    if (monthlyPaymentB > monthlyPaymentA) monthlySurplusA = monthlyPaymentB - monthlyPaymentA;
                }
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "LAPORAN ANALISA KEWANGAN - SMART MONEY PLANNER\n";
            csvContent += `Tarikh Cetakan,${new Date().toLocaleDateString('ms-MY')}\n`;
            csvContent += `Mode Analisa,${analysisMode === 'deposit' ? 'Strategi Deposit' : 'Strategi Tempoh'}\n`;
            csvContent += `Harga Aset,RM ${P_asset.toFixed(2)}\n`;
            csvContent += `Kadar Faedah,${rateLoan}%\n`;
            csvContent += `Dividen ASB,${(rateAsb*100).toFixed(1)}%\n\n`;
            
            csvContent += "Tahun,Baki Hutang A,Pelaburan A (ASB),Nilai Bersih A,Baki Hutang B,Pelaburan B (ASB),Nilai Bersih B,Perbezaan (B - A)\n";

            let monthlyRateAsb = rateAsb / 12;
            
            for (let i = 0; i <= commonTenure; i++) {
                let currentBalA = 0;
                let currentBalB = 0;

                if (method === 'flat') {
                    currentBalA = Math.max(0, A_loan - (A_loan/commonTenure * i));
                    currentBalB = Math.max(0, B_loan - (B_loan/commonTenure * i));
                } else {
                    currentBalA = getBalanceAtMonth(A_loan, rateLoan, commonTenure, calcA.monthly + extraMonthly, i * 12);
                    currentBalB = getBalanceAtMonth(B_loan, rateLoan, commonTenure, calcB.monthly, i * 12);
                }

                let currentInvA = 0;
                let currentInvB = (analysisMode === 'deposit') ? B_startInvest : 0;
                
                if (analysisMode === 'deposit') {
                    for(let m=1; m <= i*12; m++) {
                        currentInvA = currentInvA * (1 + monthlyRateAsb) + monthlySurplusA;
                        if (method === 'reducing' && isAutoMatch && m > calcA.actualMonths) {
                             currentInvA += (calcA.monthly + extraMonthly);
                        }
                    }
                    if(i > 0) currentInvB = B_startInvest * Math.pow(1 + rateAsb, i);
                } else {
                    let A_tenure = parseVal('shortTenure');
                    if(A_tenure >= commonTenure) A_tenure = commonTenure - 1;
                    
                    let diff = monthlyPaymentA - monthlyPaymentB;
                    
                    for(let m=1; m <= i*12; m++) {
                        currentInvA = currentInvA * (1 + monthlyRateAsb);
                        if (m > A_tenure * 12) currentInvA += monthlyPaymentA;
                        
                        currentInvB = currentInvB * (1 + monthlyRateAsb);
                        if (diff > 0) currentInvB += diff;
                    }
                }

                let netWorthA = (P_asset - currentBalA) + currentInvA;
                let netWorthB = (P_asset - currentBalB) + currentInvB;
                let diffNet = netWorthB - netWorthA;

                csvContent += `${i},${currentBalA.toFixed(2)},${currentInvA.toFixed(2)},${netWorthA.toFixed(2)},${currentBalB.toFixed(2)},${currentInvB.toFixed(2)},${netWorthB.toFixed(2)},${diffNet.toFixed(2)}\n`;
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Laporan_Kewangan_Ultimate.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getBalanceAtMonth(principal, ratePct, years, monthlyPayment, targetMonth) {
            let r = ratePct / 100 / 12;
            let balance = principal;
            for(let m=0; m<targetMonth; m++) {
                if(balance <= 0.1) return 0;
                let interest = balance * r;
                let principalPart = monthlyPayment - interest;
                balance -= principalPart;
            }
            return Math.max(0, balance);
        }

        function downloadChart() {
            const canvas = document.getElementById('financeChart');
            const link = document.createElement('a');
            link.download = 'Graf_Kewangan.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        window.onload = function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            setLoanType('car'); 
            syncInput('assetPrice');
            syncInput('cashOnHand');
        };

    </script>
</body>
</html>
